<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NLB Question-Answering System</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='/logo.jpg') }}">
    <link href="https://fonts.cdnfonts.com/css/frutiger" rel="stylesheet">
    <script>
        user_message = 
            "<div class='user-message align-self-start d-flex flex-row align-items-center mb-4 rounded border border-dark w-75'>"+
                "<div class='chat-message-user text-uppercase d-flex align-items-center ml-2'><strong>user_name</strong></div>" +
                "<div class='chat-message-text ml-3 d-flex align-items-center mr-2'>" +
                    "<p class='m-0'>question</p>" +
                "</div>" + 
            "</div>"

        function set_user() {
            return new Promise((resolve, reject) => {
                $.get("/api/current_user", function (response) {
                    resolve(response);
                });
            })
        }

        function add_message(object) {
            $("#messages").append(object);
        }

        function generate_spinner() {
            return "<div id='loading' class='user-message align-self-end d-flex flex-row justify-content-end mb-4 rounded align-items-center mb-4 rounded border border-dark w-75'>" +
                        "<div class='chat-message-text d-flex align-items-center ml-2'>" +
                            "<div class='spinner-grow text-dark' role='status'>" +
                                "<span class='sr-only'>Loading...</span>" +
                            "</div>" +
                        "</div>" +
                        "<div class='chat-message-user d-flex align-items-center ml-3 mr-2'><img src='./static/logo.jpg' alt='...' class='chat-message-icon'></div>" +
                    "</div>"
        }

        function remove_spinner() {
            $("#loading").remove();
        }

        $(document).ready(async function () {
            var current_user;
            await set_user().then((name) => {
                current_user = name;
            });
            var receiver = "";
            $("#chat-form").on("submit", function (e) {
                e.preventDefault();
                var message = $("input").val();
                if (message) {
                    data = {
                        "sender": current_user,
                        "message": message
                    };
                    console.log(current_user)
                    message_object = user_message.replace("question", message).replace("user_name", current_user);
                    add_message(message_object);
                    add_message(generate_spinner())
                    $.get("/api/chat", data, function (response) {
                        remove_spinner();
                        add_message(response);
                    });
                    $("input").val("");
                }
            });
        });
    </script>
</head>

<body class="container-fluid d-flex align-items-center justify-content-center">
    <div class="card rounded-pill">
        <div class="card-body d-flex flex-column align-items-center w-100 h-100">
            <div class="row aling-items-center">
                <!-- <strong id="profile"></strong> -->
                <h1 class="card-title text-center mt-4"> <strong>NLB</strong> Question-Answering System </h1>
            </div>
            <div class="row flex-grow-1 w-75 px-4">
                <div id="messages" class="d-flex flex-column w-100">
                </div>
            </div>
            <div class="row aling-self-end w-50 px-4">
                <form class="d-flex justify-content-between w-100" id="chat-form">
                    <input type="text" class="form-control" placeholder="Write your question here">
                    <button id="send" type="submit" class="btn btn-primary nlb-background ml-3">Ask</button>
                </form>
            </div>
        </div>
    </div>
</body>

</html>